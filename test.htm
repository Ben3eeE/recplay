<html>
  <head>
    <style>
      canvas {
      	border: 1px solid;
      }
    </style>
    <script src="//cdnjs.cloudflare.com/ajax/libs/require.js/2.1.8/require.min.js"></script>
    <script src="amd.js"></script>
    <script>
      window.onload = function(){
      	require(["./binReader", "./levReader", "./levRender", "./recReader", "./recRender", "./objRender", "./skyRender", "./get", "./lgr"], function(binReader, levReader, levRender, recReader, recRender, objRender, skyRender, get, lgr){
      		window.l = {
      			binReader: binReader,
      			levReader: levReader,
      			levRender: levRender
      		};
      		var canvase = document.body.appendChild(document.createElement("canvas"));
      		canvase.width = "1024";
      		canvase.height = "600";
      		var canvas = canvase.getContext("2d");
      		var lgrO = lgr("../../images");
      		get("BluR867.lev", function(lev){
      		get("BluR867_836ZWE.rec", function(rec){
      			var lrd;
      			var lrn = levRender(window.lrd = lrd = levReader(lev));
      			var lr = lrn/*.draw;*/.cached(2, function(w, h){
      				var o = document.createElement("canvas");
      				o.width = w;
      				o.height = h;
      				return o;
      			});
      			window.rec = rec;
	      		var rrd = recReader(rec);
	      		window.rrd = rrd;
	      		var rrn = recRender(rrd);
	      		var objrn = objRender(lrd, rrd);
	      		var n = 0;
	      		var start = Number(new Date());
	      		setInterval(function(){
	      			var scale = 48*1.5;
				var left = rrd.bikeX(n) - canvase.width/scale/2;
				var top = -rrd.bikeY(n) - canvase.height/scale/2;
				canvas.clearRect(0, 0, canvase.width, canvase.height);
				canvas.save();
				if(window.hehe){
					canvas.translate(canvase.width/2, canvase.height/2);
					canvas.rotate(rrd.bikeR(n)*Math.PI*2/10000);
					canvas.translate(-scale*rrd.headX(n)/1000, scale*rrd.headY(n)/1000);
					canvas.translate(-canvase.width/2, -canvase.height/2);
				}
				//lrn.drawSky(canvas, lgrO, left, top, canvase.width/scale, canvase.height/scale, scale);
				lr(canvas, lgrO, left, top, canvase.width/scale, canvase.height/scale, scale);
				objrn.draw(canvas, lgrO, n, left, top, scale);
				rrn.draw(canvas, lgrO, n, left, top, scale);
				canvas.restore();
				n++;
				if(n >= rrd.frameCount()){
					var end = Number(new Date());
					console.log((end - start) + " ms; " + 1000*n/(end - start) + " fps");
					start = end;
					n = 0;
				}
			}, 1000/30);
	      	});
	      	});
      	});
      }
      window.hehe = false;
    </script>
  </head>
  <body>
    <a href="javascript:(hehe=!hehe,void(0))">hehe</a><br>
  </body>
</html>
