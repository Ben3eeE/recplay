<html>
  <head>
    <style>
      canvas {
      	border: 1px solid;
      }
    </style>
    <script src="amd.js"></script>
    <script>
      window.onload = function(){
      	require(["./levReader", "./recReader", "./get", "./lgr", "./player"], function(levReader, recReader, get, lgr, player){
      		var canvase = document.body.appendChild(document.createElement("canvas"));
      		canvase.width = "1280";
      		canvase.height = "600";
      		var canvas = canvase.getContext("2d");
      		get("mawpi712.lev", function(lev){
      			var pl = player(levReader(lev), lgr("./images"), function(w, h){
      				var o = document.createElement("canvas");
      				o.width = w;
      				o.height = h;
      				return o;
      			});
      			window.pl = pl; // just so it's accessible in the console

			function but(lbl, fun){
      				var a = document.body.insertBefore(document.createElement("a"), canvase);
      				a.href = "#";
      				a.onclick = function(e){
      					console.log(fun());
      					e.preventDefault();
      				};
      				a.appendChild(document.createTextNode(lbl));
      				document.body.insertBefore(document.createTextNode(" "), canvase);
      			}

      			but("in", function(){
      				return pl.setScale100(pl.getScale100() + 10);
      			});
      			but("out", function(){
      				return pl.setScale100(pl.getScale100() - 10);
      			});
      			but("z1", function(){
      				return pl.setScale100(100);
      			});
       			but("faster", function(){
      				return pl.setSpeed100(pl.getSpeed100() + 10);
      			});
      			but("slower", function(){
      				return pl.setSpeed100(pl.getSpeed100() - 10);
      			});
      			but("s1", function(){
      				return pl.setSpeed100(100);
      			});
      			but("s0", function(){
      				return pl.setSpeed100(0);
      			});
      			but("-s", function(){
      				return pl.setSpeed100(-pl.getSpeed100());
      			});
      			
      			document.body.insertBefore(document.createElement("br"), canvase);

      			function anim(){
	      			pl.draw(canvas, 0, 0, canvase.width, canvase.height, true);
	      			// note: this actually uses 4/3 times the CPU on Chromium as setInterval
	      			requestAnimationFrame(anim);
	      			//setTimeout(anim, 1000/30);
	      		}
	      		anim();
//	      		setInterval(anim, 1000/60);

/*	      		setInterval(function(){
	      			//pl.draw(canvas, canvase.width*0.25, canvase.height*0.25, canvase.width/2, canvase.height/2);
	      			if(raf === null)
	      				raf = requestAnimationFrame(anim);
			}, 30);*/
			["mawpi712_218Max.rec", "mawpi712_218adi.rec"].forEach(function(n){
				get(n, function(rec){
					pl.addReplay(recReader(rec));
				});
			});

			canvase.onclick = function(e){
				pl.changeFocus();
				e.preventDefault();
			};
	      	});
      	});
      }
    </script>
  </head>
  <body>
  </body>
</html>
